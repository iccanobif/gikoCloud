#include <inttypes.h>
#include <freepoi/amf/codec.h>
#include <freepoi/net/rtmp.h>
#include <freepoi/red5/rtmp.h>
#include "test.h"

uint8_t original[426] = {
    0x03, 0x00, 0x00, 0x01, 0x00, 0x01, 0x9B, 0x14,
    0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x07, 0x63,
    0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x00, 0x3f,
    0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x00, 0x03, 0x61, 0x70, 0x70, 0x02, 0x00, 0x0e,
    0x67, 0x69, 0x6b, 0x6f, 0x70, 0x6f, 0x69, 0x31,
    0x34, 0x31, 0x5f, 0x66, 0x6f, 0x72, 0x00, 0x08,
    0x66, 0x6c, 0x61, 0x73, 0x68, 0x56, 0x65, 0x72,
    0x02, 0x00, 0x0e, 0x57, 0x49, 0x4e, 0x20, 0x32,
    0x31, 0x2c, 0x30, 0x2c, 0x30, 0x2c, 0x31, 0x38,
    0x32, 0x00, 0x06, 0x73, 0x77, 0x66, 0x55, 0x72,
    0x6c, 0x02, 0x00, 0x3c, 0x68, 0x74, 0x74, 0x70,
    0x3a, 0x2f, 0x2f, 0x6c, 0x34, 0x63, 0x73, 0x2e,
    0x6a, 0x70, 0x6e, 0x2e, 0x6f, 0x72, 0x67, 0x2f,
    0x67, 0x69, 0x6b, 0x6f, 0x70, 0x6f, 0x69, 0x2f,
    0x66, 0x6c, 0x61, 0x73, 0x68, 0x2f, 0x67, 0x69,
    0x6b, 0x6f, 0x70, 0x6f, 0x69, 0x31, 0x34, 0x31,
    0x5f, 0x66, 0x6f, 0x72, 0xc3, 0x2f, 0x67, 0x69,
    0x6b, 0x6f, 0x70, 0x6f, 0x69, 0x2e, 0x73, 0x77,
    0x66, 0x00, 0x05, 0x74, 0x63, 0x55, 0x72, 0x6c,
    0x02, 0x00, 0x2f, 0x72, 0x74, 0x6d, 0x70, 0x3a,
    0x2f, 0x2f, 0x74, 0x73, 0x77, 0x69, 0x6e, 0x64,
    0x79, 0x2e, 0x73, 0x65, 0x72, 0x76, 0x65, 0x66,
    0x74, 0x70, 0x2e, 0x6e, 0x65, 0x74, 0x3a, 0x31,
    0x39, 0x33, 0x37, 0x2f, 0x67, 0x69, 0x6b, 0x6f,
    0x70, 0x6f, 0x69, 0x31, 0x34, 0x31, 0x5f, 0x66,
    0x6f, 0x72, 0x00, 0x04, 0x66, 0x70, 0x61, 0x64,
    0x01, 0x00, 0x00, 0x0c, 0x63, 0x61, 0x70, 0x61,
    0x62, 0x69, 0x6c, 0x69, 0x74, 0x69, 0x65, 0x73,
    0x00, 0x40, 0x6d, 0xe0, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0b, 0x61, 0x75, 0x64, 0x69, 0x6f,
    0x43, 0x6f, 0x64, 0x65, 0x63, 0x73, 0x00, 0x40,
    0xab, 0xee, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0b, 0x76, 0x69, 0x64, 0x65, 0xc3, 0x6f, 0x43,
    0x6f, 0x64, 0x65, 0x63, 0x73, 0x00, 0x40, 0x6f,
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d,
    0x76, 0x69, 0x64, 0x65, 0x6f, 0x46, 0x75, 0x6e,
    0x63, 0x74, 0x69, 0x6f, 0x6e, 0x00, 0x3f, 0xf0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07,
    0x70, 0x61, 0x67, 0x65, 0x55, 0x72, 0x6c, 0x02,
    0x00, 0x43, 0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f,
    0x2f, 0x6c, 0x34, 0x63, 0x73, 0x2e, 0x6a, 0x70,
    0x6e, 0x2e, 0x6f, 0x72, 0x67, 0x2f, 0x67, 0x69,
    0x6b, 0x6f, 0x70, 0x6f, 0x69, 0x2f, 0x66, 0x6c,
    0x61, 0x73, 0x68, 0x2f, 0x67, 0x69, 0x6b, 0x6f,
    0x70, 0x6f, 0x69, 0x31, 0x34, 0x31, 0x5f, 0x66,
    0x6f, 0x72, 0x2f, 0x66, 0x6c, 0x61, 0x73, 0x68,
    0x5f, 0x67, 0x69, 0x6b, 0x6f, 0x70, 0x6f, 0x69,
    0x2e, 0x68, 0x74, 0x6d, 0x6c, 0x00, 0x00, 0x09,
    0x02, 0x00, 0x09, 0x41, 0x6e, 0x6f, 0xc3, 0x6e,
    0x79, 0x6d, 0x6f, 0x75, 0x73, 0x02, 0x00, 0x12,
    0x64, 0x74, 0x33, 0x30, 0x33, 0x65, 0x6d, 0x6c,
    0x38, 0x38, 0x35, 0x38, 0x37, 0x39, 0x32, 0x32,
    0x38, 0x31
};

#define freepoi_test(...)  fprintf(stderr, __VA_ARGS__)

static const struct freepoi_short_string name_app = {"app", 0, 3};
static const struct freepoi_short_string name_flash_ver = {"flashVer", 0, 8};
static const struct freepoi_short_string name_swf_url = {"swfUrl", 0, 6};
static const struct freepoi_short_string name_fpad = {"fpad", 0, 4};
static const struct freepoi_short_string name_capabilities = {"capabilities", 0, 12};
static const struct freepoi_short_string name_audio_codecs = {"audioCodecs", 0, 11};
static const struct freepoi_short_string name_video_codecs = {"videoCodecs", 0, 11};
static const struct freepoi_short_string name_video_function = {"videoFunction", 0, 13};
static const struct freepoi_short_string name_page_url = {"pageUrl", 0, 7};
static const struct freepoi_short_string name_tc_url = {"tcUrl", 0, 5};

int
main(void)
{
    uint8_t buf[440], *end = &buf[440], *start, *pp, buf2[480];
    uint8_t *ptr = start = freepoi_initialize_packet_buffer(buf);
    int i, nchunks, nbytes;
    struct freepoi_packet pkt;
    uint8_t htype, hsize;
    uint32_t ts;

    memset(buf, 0, sizeof(buf));
    ptr = freepoi_amf_encode_string(ptr, end - ptr, "connect", 7);
    ptr = freepoi_amf_encode_number(ptr, end - ptr, 1);
    ptr = freepoi_amf_encode_begin_object(ptr, end - ptr);
    ptr = freepoi_amf_encode_named_string(ptr, end - ptr,
                                          &name_app,
                                          "gikopoi141_for", 14);
    ptr = freepoi_amf_encode_named_string(ptr, end - ptr,
                                          &name_flash_ver,
                                          "WIN 21,0,0,182", 14);
    ptr = freepoi_amf_encode_named_string(ptr,
                                          end - ptr,
                                          &name_swf_url,
                                          "http://l4cs.jpn.org/gikopoi/flash/gikopoi141_for/gikopoi.swf",
                                          60);
    ptr = freepoi_amf_encode_named_string(ptr, end - ptr,
                                          &name_tc_url,
                                          "rtmp://tswindy.serveftp.net:1937/gikopoi141_for",
                                          47);
    ptr = freepoi_amf_encode_named_boolean(ptr, end - ptr,
                                           &name_fpad,
                                           0);
    ptr = freepoi_amf_encode_named_number(ptr, end - ptr,
                                          &name_capabilities,
                                          239);
    ptr = freepoi_amf_encode_named_number(ptr, end - ptr,
                                          &name_audio_codecs,
                                          3575);
    ptr = freepoi_amf_encode_named_number(ptr, end - ptr,
                                          &name_video_codecs,
                                          252);
    ptr = freepoi_amf_encode_named_number(ptr, end - ptr,
                                          &name_video_function,
                                          1);
    ptr = freepoi_amf_encode_named_string(ptr, end - ptr,
                                          &name_page_url,
                                          "http://l4cs.jpn.org/gikopoi/flash/gikopoi141_for/flash_gikopoi.html", 67);
    ptr = freepoi_amf_encode_end_object(ptr, end - ptr);
    ptr = freepoi_amf_encode_string(ptr, end - ptr, "Anonymous", 9);
    ptr = freepoi_amf_encode_string(ptr, end - ptr, "dt303eml8858792281", 18);
    // packet meta info
    freepoi_initialize_packet(&pkt,
                              start,
                              ptr - start,
                              FREEPOI_COMMAND_PACKET,
                              1,
                              0,
                              3);
    freepoi_get_header_variables(&pkt, NULL, &htype, &hsize, &ts);
    freepoi_encode_packet_header(&pkt, buf2, htype, hsize, ts);
    nchunks = freepoi_get_packet_chunk_count(&pkt, 128);

    {
        print_test_message("Checking if the generated packet is of the same size as the original");

        nbytes = freepoi_chunkify_packet_data(&pkt,
                                              &buf2[hsize],
                                              sizeof(buf2),
                                              128,
                                              nchunks);

        test_verbose(nbytes == sizeof(original) - hsize,
                     "Expected %d, got %d\n",
                     (int)sizeof(original) - hsize,
                     nbytes);
    }
    {
        print_test_message("Checking if the generated packet data is identical to the original");

        for (pp = buf2; *pp == 0; pp++);

        for (i = 0; pp[i] == original[i] && i < sizeof(original); ++i);

        test_verbose(i == sizeof(original),
                     "Different byte at offset %d: Expected 0x%02x, got 0x%02x\n", i,
                     original[i],
                     pp[i]);
    }
    return ALL_CLEAR;
}
